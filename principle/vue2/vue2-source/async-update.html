<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.60">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>异步更新原理 | JavaScript Blog</title><meta name="description" content="积硅步 至千里">
    <link rel="preload" href="/blog/assets/style-8ee415a3.css" as="style"><link rel="stylesheet" href="/blog/assets/style-8ee415a3.css">
    <link rel="modulepreload" href="/blog/assets/app-1830d0b2.js"><link rel="modulepreload" href="/blog/assets/framework-96b046e1.js"><link rel="modulepreload" href="/blog/assets/async-update.html-9924596d.js"><link rel="modulepreload" href="/blog/assets/async-update.html-a229d772.js"><link rel="prefetch" href="/blog/assets/index.html-a1f0bb93.js" as="script"><link rel="prefetch" href="/blog/assets/inherit.html-fd139f62.js" as="script"><link rel="prefetch" href="/blog/assets/judge-data-type.html-d57979c6.js" as="script"><link rel="prefetch" href="/blog/assets/promise.html-d67c7456.js" as="script"><link rel="prefetch" href="/blog/assets/prototype.html-f69ca0bf.js" as="script"><link rel="prefetch" href="/blog/assets/this.html-7a84113c.js" as="script"><link rel="prefetch" href="/blog/assets/module-specification.html-8659637a.js" as="script"><link rel="prefetch" href="/blog/assets/defineProperty.html-716209ad.js" as="script"><link rel="prefetch" href="/blog/assets/life-cycle.html-26a56f80.js" as="script"><link rel="prefetch" href="/blog/assets/scoped.html-d13e21f1.js" as="script"><link rel="prefetch" href="/blog/assets/clone.html-bff290af.js" as="script"><link rel="prefetch" href="/blog/assets/function's-func.html-79bdc9af.js" as="script"><link rel="prefetch" href="/blog/assets/throttle-debounce.html-ff05f62f.js" as="script"><link rel="prefetch" href="/blog/assets/cache.html-9b3fe6f8.js" as="script"><link rel="prefetch" href="/blog/assets/array-update.html-0d7b21c3.js" as="script"><link rel="prefetch" href="/blog/assets/debug.html-2dd8fcfd.js" as="script"><link rel="prefetch" href="/blog/assets/initial-rendering.html-dad18193.js" as="script"><link rel="prefetch" href="/blog/assets/render-update.html-b8c89ff5.js" as="script"><link rel="prefetch" href="/blog/assets/responsive.html-17fdf7e6.js" as="script"><link rel="prefetch" href="/blog/assets/template-compilation.html-c010724a.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-421116f5.js" as="script"><link rel="prefetch" href="/blog/assets/inherit.html-8382609d.js" as="script"><link rel="prefetch" href="/blog/assets/judge-data-type.html-a0029b4e.js" as="script"><link rel="prefetch" href="/blog/assets/promise.html-e88d8e82.js" as="script"><link rel="prefetch" href="/blog/assets/prototype.html-3890dd86.js" as="script"><link rel="prefetch" href="/blog/assets/this.html-86144448.js" as="script"><link rel="prefetch" href="/blog/assets/module-specification.html-014a107d.js" as="script"><link rel="prefetch" href="/blog/assets/defineProperty.html-c00730e6.js" as="script"><link rel="prefetch" href="/blog/assets/life-cycle.html-a1e4a4ff.js" as="script"><link rel="prefetch" href="/blog/assets/scoped.html-c9702f6c.js" as="script"><link rel="prefetch" href="/blog/assets/clone.html-be7a3edc.js" as="script"><link rel="prefetch" href="/blog/assets/function's-func.html-d7a05aed.js" as="script"><link rel="prefetch" href="/blog/assets/throttle-debounce.html-98b25fc9.js" as="script"><link rel="prefetch" href="/blog/assets/cache.html-584f0c38.js" as="script"><link rel="prefetch" href="/blog/assets/array-update.html-a3446714.js" as="script"><link rel="prefetch" href="/blog/assets/debug.html-54362a76.js" as="script"><link rel="prefetch" href="/blog/assets/initial-rendering.html-b9c091d3.js" as="script"><link rel="prefetch" href="/blog/assets/render-update.html-706ac64e.js" as="script"><link rel="prefetch" href="/blog/assets/responsive.html-48b86c4d.js" as="script"><link rel="prefetch" href="/blog/assets/template-compilation.html-47572d94.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-46166703.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><img class="logo" src="/blog/images/hero.jpg" alt="JavaScript Blog"><span class="site-name can-hide">JavaScript Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/principle/deep-js/promise" class="" aria-label="原理"><!--[--><!--]--> 原理 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/web/browser/cache" class="" aria-label="Web体系"><!--[--><!--]--> Web体系 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://chasewindyoungs.github.io/leetcode-book/" rel="noopener noreferrer" target="_blank" aria-label="JS算法书"><!--[--><!--]--> JS算法书 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ChaseWindYoungs/blog" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/principle/deep-js/promise" class="" aria-label="原理"><!--[--><!--]--> 原理 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/web/browser/cache" class="" aria-label="Web体系"><!--[--><!--]--> Web体系 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://chasewindyoungs.github.io/leetcode-book/" rel="noopener noreferrer" target="_blank" aria-label="JS算法书"><!--[--><!--]--> JS算法书 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ChaseWindYoungs/blog" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">深入理解JS <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/blog/principle/deep-js/promise.html" class="sidebar-item" aria-label="Promise"><!--[--><!--]--> Promise <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/deep-js/inherit.html" class="sidebar-item" aria-label="继承-JS多方式实现"><!--[--><!--]--> 继承-JS多方式实现 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/deep-js/this.html" class="sidebar-item" aria-label="this的理解"><!--[--><!--]--> this的理解 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/deep-js/judge-data-type.html" class="sidebar-item" aria-label="判断数据类型"><!--[--><!--]--> 判断数据类型 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/deep-js/prototype.html" class="sidebar-item" aria-label="原型和原型链"><!--[--><!--]--> 原型和原型链 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">Vue2原理 <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/principle/vue2/defineProperty.html" class="sidebar-item" aria-label="Vue响应式原理"><!--[--><!--]--> Vue响应式原理 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/life-cycle.html" class="sidebar-item" aria-label="生命周期"><!--[--><!--]--> 生命周期 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/scoped.html" class="sidebar-item" aria-label="vue scoped原理"><!--[--><!--]--> vue scoped原理 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item active collapsible">Vue2源码学习 <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/principle/vue2/vue2-source/debug.html" class="sidebar-item" aria-label="源码调试"><!--[--><!--]--> 源码调试 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/vue2-source/responsive.html" class="sidebar-item" aria-label="响应式数据的原理"><!--[--><!--]--> 响应式数据的原理 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/vue2-source/template-compilation.html" class="sidebar-item" aria-label="模板渲染原理"><!--[--><!--]--> 模板渲染原理 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/vue2-source/initial-rendering.html" class="sidebar-item" aria-label="初始渲染原理"><!--[--><!--]--> 初始渲染原理 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/vue2-source/render-update.html" class="sidebar-item" aria-label="渲染更新原理"><!--[--><!--]--> 渲染更新原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/principle/vue2/vue2-source/async-update.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="异步更新原理"><!--[--><!--]--> 异步更新原理 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/vue2/vue2-source/array-update.html" class="sidebar-item" aria-label="数组更新原理"><!--[--><!--]--> 数组更新原理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">代码手写 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/blog/principle/write-by-hand/function&#39;s-func.html" class="sidebar-item" aria-label="call、apply、bind"><!--[--><!--]--> call、apply、bind <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/write-by-hand/clone.html" class="sidebar-item" aria-label="浅拷贝与深拷贝"><!--[--><!--]--> 浅拷贝与深拷贝 <!--[--><!--]--></a><!----></li><li><a href="/blog/principle/write-by-hand/throttle-debounce.html" class="sidebar-item" aria-label="防抖、截流"><!--[--><!--]--> 防抖、截流 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">工程化 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/blog/principle/engineeringization/module-specification.html" class="sidebar-item" aria-label="模块规范(CommonJS,AMD,CMD,UMD,ES Module)"><!--[--><!--]--> 模块规范(CommonJS,AMD,CMD,UMD,ES Module) <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><p>Vue 渲染更新原理 咱们已经可以实现数据改变，视图自动更新了<br>那么此篇主要是对视图更新的性能优化，包含 nextTick 这一重要的 api 实现</p><p>每次我们改变数据的时候都会触发相应的 watcher 进行更新，<br>如果是渲染 watcher 那是不是意味着，数据变动一次就会重新渲染一次<br>这样其实是很浪费性能的，我们有没有更好的方法，让数据变动完毕后统一去更新视图呢</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>&lt;script&gt;
  <span class="token comment">// Vue实例化</span>
  let vm = new Vue(<span class="token punctuation">{</span>
    el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
    data() <span class="token punctuation">{</span>
      return <span class="token punctuation">{</span>
        a<span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>;
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// render(h) {</span>
    <span class="token comment">//   return h(&#39;div&#39;,{id:&#39;a&#39;},&#39;hello&#39;)</span>
    <span class="token comment">// },</span>
    template<span class="token operator">:</span> `&lt;div id=<span class="token string">&quot;a&quot;</span>&gt;hello <span class="token punctuation">{</span><span class="token punctuation">{</span>a<span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;/div&gt;`<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>);

  <span class="token comment">// 当我们每一次改变数据的时候  渲染watcher都会执行一次 这个是影响性能的</span>
  setTimeout(() =&gt; <span class="token punctuation">{</span>
    vm.a = <span class="token number">1</span>;
    vm.a = <span class="token number">2</span>;
    vm.a = <span class="token number">3</span>;
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span>);
&lt;/script&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1、watcher-更新的改写" tabindex="-1"><a class="header-anchor" href="#_1、watcher-更新的改写" aria-hidden="true">#</a> 1、watcher 更新的改写</h2><p>把 update 更新方法改一下 增加异步队列的机制</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>import <span class="token punctuation">{</span> queueWatcher <span class="token punctuation">}</span> from <span class="token string">&quot;./scheduler&quot;</span>;
export default class Watcher <span class="token punctuation">{</span>
  update() <span class="token punctuation">{</span>
    <span class="token comment">// 每次watcher进行更新的时候  是否可以让他们先缓存起来  之后再一起调用</span>
    <span class="token comment">// 异步队列机制 （防抖）</span>
    queueWatcher(this);
  <span class="token punctuation">}</span>
  run() <span class="token punctuation">{</span>
    <span class="token comment">// 真正的触发更新</span>
    this.get();
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、queuewatcher-实现队列机制" tabindex="-1"><a class="header-anchor" href="#_2、queuewatcher-实现队列机制" aria-hidden="true">#</a> 2、queueWatcher 实现队列机制</h2><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>import <span class="token punctuation">{</span> nextTick <span class="token punctuation">}</span> from <span class="token string">&quot;../util/next-tick&quot;</span>;
let queue = <span class="token punctuation">[</span><span class="token punctuation">]</span>;
let has = <span class="token punctuation">{</span><span class="token punctuation">}</span>;
function flushSchedulerQueue() <span class="token punctuation">{</span>
  for (let index = <span class="token number">0</span>; index &lt; queue.length; index++) <span class="token punctuation">{</span>
    <span class="token comment">//   调用watcher的run方法 执行真正的更新操作</span>
    queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>.run();
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行完之后清空队列</span>
  queue = <span class="token punctuation">[</span><span class="token punctuation">]</span>;
  has = <span class="token punctuation">{</span><span class="token punctuation">}</span>;
<span class="token punctuation">}</span>

<span class="token comment">// 实现异步队列机制</span>
export function queueWatcher(watcher) <span class="token punctuation">{</span>
  const id = watcher.id;
  <span class="token comment">//   watcher去重</span>
  if (has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> === undefined) <span class="token punctuation">{</span>
    <span class="token comment">//  同步代码执行 把全部的watcher都放到队列里面去</span>
    queue.push(watcher);
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> = <span class="token boolean">true</span>;
    <span class="token comment">// 进行异步调用</span>
    nextTick(flushSchedulerQueue);
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、nexttick-实现原理" tabindex="-1"><a class="header-anchor" href="#_3、nexttick-实现原理" aria-hidden="true">#</a> 3、nextTick 实现原理</h2><p>因为 nextTick 用户也可以手动调用 <br><strong>主要思路就是采用微任务优先的方式调用异步方法去执行 nextTick 包装的方法</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>let callbacks = <span class="token punctuation">[</span><span class="token punctuation">]</span>;
let pending = <span class="token boolean">false</span>;
function flushCallbacks() <span class="token punctuation">{</span>
  pending = <span class="token boolean">false</span>; <span class="token comment">//把标志还原为false</span>
  <span class="token comment">// 依次执行回调</span>
  for (let i = <span class="token number">0</span>; i &lt; callbacks.length; i++) <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span>();
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
let timerFunc; <span class="token comment">//定义异步方法  采用优雅降级</span>
if (typeof Promise !== <span class="token string">&quot;undefined&quot;</span>) <span class="token punctuation">{</span>
  <span class="token comment">// 如果支持promise</span>
  const p = Promise.resolve();
  timerFunc = () =&gt; <span class="token punctuation">{</span>
    p.then(flushCallbacks);
  <span class="token punctuation">}</span>;
<span class="token punctuation">}</span> else if (typeof MutationObserver !== <span class="token string">&quot;undefined&quot;</span>) <span class="token punctuation">{</span>
  <span class="token comment">// MutationObserver 主要是监听dom变化 也是一个异步方法</span>
  let counter = <span class="token number">1</span>;
  const observer = new MutationObserver(flushCallbacks);
  const textNode = document.createTextNode(String(counter));
  observer.observe(textNode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    characterData<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>);
  timerFunc = () =&gt; <span class="token punctuation">{</span>
    counter = (counter + <span class="token number">1</span>) % <span class="token number">2</span>;
    textNode.data = String(counter);
  <span class="token punctuation">}</span>;
<span class="token punctuation">}</span> else if (typeof setImmediate !== <span class="token string">&quot;undefined&quot;</span>) <span class="token punctuation">{</span>
  <span class="token comment">// 如果前面都不支持 判断setImmediate</span>
  timerFunc = () =&gt; <span class="token punctuation">{</span>
    setImmediate(flushCallbacks);
  <span class="token punctuation">}</span>;
<span class="token punctuation">}</span> else <span class="token punctuation">{</span>
  <span class="token comment">// 最后降级采用setTimeout</span>
  timerFunc = () =&gt; <span class="token punctuation">{</span>
    setTimeout(flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span>);
  <span class="token punctuation">}</span>;
<span class="token punctuation">}</span>

export function nextTick(cb) <span class="token punctuation">{</span>
  <span class="token comment">// 除了渲染watcher  还有用户自己手动调用的nextTick 一起被收集到数组</span>
  callbacks.push(cb);
  if (!pending) <span class="token punctuation">{</span>
    <span class="token comment">// 如果多次调用nextTick  只会执行一次异步 等异步队列清空之后再把标志变为false</span>
    pending = <span class="token boolean">true</span>;
    timerFunc();
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、-nexttick-挂载原型" tabindex="-1"><a class="header-anchor" href="#_4、-nexttick-挂载原型" aria-hidden="true">#</a> 4、$nextTick 挂载原型</h2><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>import <span class="token punctuation">{</span> nextTick <span class="token punctuation">}</span> from <span class="token string">&quot;./util/next-tick&quot;</span>;

export function renderMixin(Vue) <span class="token punctuation">{</span>
  <span class="token comment">// 挂载在原型的nextTick方法 可供用户手动调用</span>
  Vue.prototype.$nextTick = nextTick;
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">作者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: sirius.cheng@yunlsp.com">sirius.cheng</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/blog/principle/vue2/vue2-source/render-update.html" class="" aria-label="渲染更新原理"><!--[--><!--]--> 渲染更新原理 <!--[--><!--]--></a></span><span class="next"><a href="/blog/principle/vue2/vue2-source/array-update.html" class="" aria-label="数组更新原理"><!--[--><!--]--> 数组更新原理 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-1830d0b2.js" defer></script>
  </body>
</html>
