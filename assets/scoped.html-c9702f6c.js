import{_ as e,p as o,q as r,a1 as d}from"./framework-96b046e1.js";const s={},t=d('<h1 id="vue-scoped-原理" tabindex="-1"><a class="header-anchor" href="#vue-scoped-原理" aria-hidden="true">#</a> Vue scoped 原理</h1><ol><li><p>scoped 表现</p><p>当 style 标签加上 scoped 属性时，scoped 会在 DOM 结构及 css 样式上加上唯一性的标记 <strong>data-v-xxx</strong> 属性，从而达到样式私有化，不污染全局的作用。</p></li><li><p>本质</p><p><strong>基于 HTML 和 CSS 属性选择器</strong>，即分别给 HTML 标签和 CSS 选择器添加 data-v-xxx</p><p><strong>通过 vue-loader 实现</strong> 的，实现过程大致分 3 步：</p><ul><li>首先 vue-loader 会解析 .vue 组件，提取出 template、script、style 对应的代码块；</li><li>然后构造组件实例，在组件实例的选项上绑定 ScopedId；</li><li>最后对 style 的 CSS 代码进行编译转化，应用 ScopedId 生成选择器的属性；</li></ul></li><li><p>原理</p><p>涉及到 vue-loader 的处理策略：</p><p>Vue scoped，原理，涉及到 vue-loader 的处理策略：</p><p>一、首先呢，是 <strong>VueLoaderPlugin</strong> 策略：</p><p>VueLoaderPlugin 先获取了 webpack 原来的 rules（ 即 <code>compiler.option.module.rule</code> 的比如 <code>test:/.vue$/</code> 规则），然后创建了<code>pitcher</code> 规则，pitcher 中的 <strong>pitcher-loader</strong> 可以通过 <strong>resourceQuery</strong> 识别引入文件的 <strong>query</strong> 带的关键字，进行 <strong>loader</strong> 解析；（pitcher-loader 提供了前置运行和熔断运行的机制）</p><p>然后 VueLoaderPlugin 将进行 <code>clonedRule</code>（ 即对 <strong>vueRule</strong> 以外的 rule 进行处理），具体是重写 <strong>resource</strong> 和 <strong>resourceQuery</strong>，使得 loader 最终能匹配上文件；</p><p>举例：对于 vue+ts 的写法，会在 vue 的 script 标签中加上 <strong>lang=&#39;ts’</strong>，重写后 <strong>fakeresourceQuery</strong> 文件路径为 xx.vue.ts，然后结合<strong>ts-loader</strong> 的 resource 过滤方法<code>/.tsx?$/</code> 匹配上文件</p><p>然后才来到：<code>vueRule</code> 的 vue-loader 执行阶段；</p><p>（VueLoaderPlugin 就是来处理 rule 的，让 loader 能够和文件匹配。处理顺序：<code>pitcher</code> ⇒ <code>clonedRule</code> ⇒ <code>vueRule</code>）</p><p>二、 有了上面的匹配文件，接着来到了 <strong>vue-loader</strong> 处理环节，</p><p>首先 <code>@vue/component-compiler-utils</code> <code>.parse</code> 方法可以将 .vue 文件按照 <strong>template/script/style</strong> 分成代码块，</p><p>此时会根据文件路径和文件内容生成 <code>hash</code> 值，并赋给 id ，跟在文件参数后面；</p><p>三、<code>stylePostLoader</code></p><p>对于 style 代码块，vue-loader 会在 css-loader 前增加<code>stylePostLoader</code>，</p><p><code>stylePostLoader</code> 正是 Vue scoped 的原理核心之一，它会给每个选择器增加属性<code>[data-v-hash]</code> ，</p><p>这里的 hash 值就是上面的 id 值；</p><p>四、data-v-hash</p><p>同时，对于 template 的 render 块，vue-loader 的 <code>normalizeComponent</code> 方法，判断如果 vue 文件中有 scoped 的 style，则其返回的 <strong><code>options._ScopedId</code></strong> 为上面的 scopedId；</p><p>在 vnode 渲染生成 DOM 的时候会在 dom元素上增增加 scopedId，也就是增加 data-v-hash。</p></li></ol>',2),c=[t];function p(l,n){return o(),r("div",null,c)}const u=e(s,[["render",p],["__file","scoped.html.vue"]]);export{u as default};
