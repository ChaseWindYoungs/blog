---
title: Vueå“åº”å¼åŸç†
---
# Vueå“åº”å¼åŸç†(Object.defineProperty)å…¨è¿‡ç¨‹è§£æ

### Vue å¦‚ä½•åŠ¨æ€çš„æ›´æ–°

<aside>
ğŸ’¡ Vue çš„å“åº”å¼åŸç†æ˜¯é€šè¿‡ Object.defineProperty å®ç°çš„ã€‚è¢« Object.defineProperty ç»‘å®šè¿‡çš„å¯¹è±¡ï¼Œä¼šå˜æˆã€Œå“åº”å¼ã€åŒ–ã€‚ä¹Ÿå°±æ˜¯æ”¹å˜è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ä¼šè§¦å‘ get å’Œ set äº‹ä»¶ã€‚è¿›è€Œè§¦å‘ä¸€äº›è§†å›¾æ›´æ–°ã€‚å…¶ä¸­æœ€é‡è¦çš„å‡ ä¸ªç‚¹åŒ…æ‹¬ Observerï¼Œ defineReactiveï¼Œ Depï¼Œ Watcher

</aside>

### Observerã€Œå“åº”å¼ã€

 

 å¾ªç¯ä¿®æ”¹ä¸ºæ¯ä¸ªå±æ€§æ·»åŠ  get set

```jsx
const Observer = function (data) {
// å¾ªç¯ä¿®æ”¹ä¸ºæ¯ä¸ªå±æ€§æ·»åŠ get setfor (let key in data) {
    defineReactive(data, key);
  }
};
```

Object.defineProperty: å®ç°ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¹¶ä¸”å°†å¯¹è±¡çš„æ”¹å˜æ¨é€åˆ°è°ƒåº¦ä¸­å¿ƒ Dep ä¸­

ä¸¾ä¸ªä¾‹å­ ğŸŒ°ï¼š

```jsx
function defineReactive(obj, key, val) {
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: () => {
      console.log("æˆ‘è¢«è¯»äº†ï¼Œæˆ‘è¦ä¸è¦åšç‚¹ä»€ä¹ˆå¥½?");
      return val;
    },
    set: (newVal) => {
      if (val === newVal) {
        return;
      }
      val = newVal;
      console.log("æ•°æ®è¢«æ”¹å˜äº†ï¼Œæˆ‘è¦æŠŠæ–°çš„å€¼æ¸²æŸ“åˆ°é¡µé¢ä¸Šå»!");
    },
  });
}

let data = {
  text: "hello world",
};

// å¯¹dataä¸Šçš„textå±æ€§è¿›è¡Œç»‘å®š
defineReactive(data, "text", data.text);

console.log(data.text);// æ§åˆ¶å°è¾“å‡º <æˆ‘è¢«è¯»äº†ï¼Œæˆ‘è¦ä¸è¦åšç‚¹ä»€ä¹ˆå¥½?>
data.text = "hello Vue";// æ§åˆ¶å°è¾“å‡º <hello Vue && æ•°æ®è¢«æ”¹å˜äº†ï¼Œæˆ‘è¦æŠŠæ–°çš„å€¼æ¸²æŸ“åˆ°é¡µé¢ä¸Šå»!>
```

### Dep ã€Œä¾èµ–ç®¡ç†ã€

Dep å¯¹è±¡ç”¨äºä¾èµ–æ”¶é›†ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå®Œæˆäº†æ•°æ® Data å’Œæ¸²æŸ“è§†å›¾ Watcher çš„è®¢é˜…ï¼Œ

Depå¯¹è±¡ä¸­çš„ subs æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾æœé›†åˆ°çš„ æ‰€æœ‰ä½¿ç”¨åˆ°è¿™ä¸ª data çš„ Watcher å¯¹è±¡ å¯¹è±¡é›†åˆ

```jsx
class Dep {
  // æ ¹æ® ts ç±»å‹æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º Dep.target æ˜¯ä¸€ä¸ª Watcher ç±»å‹ã€‚
  static target: ?Watcher;
  // subs å­˜æ”¾æœé›†åˆ°çš„ Watcher å¯¹è±¡é›†åˆ
  subs: Array<Watcher>;
  constructor() {
    this.subs = [];
  }
  addSub(sub: Watcher) {
    // æœé›†æ‰€æœ‰ä½¿ç”¨åˆ°è¿™ä¸ª data çš„ Watcher å¯¹è±¡ã€‚
    this.subs.push(sub);
  }
  depend() {
    if (Dep.target) {
      // æœé›†ä¾èµ–ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ä¸Šé¢çš„ addSub æ–¹æ³•
      Dep.target.addDep(this);
    }
  }
  notify() {
    const subs = this.subs.slice();
    for (let i = 0, l = subs.length; i < l; i++) {
      // è°ƒç”¨å¯¹åº”çš„ Watcherï¼Œæ›´æ–°è§†å›¾
      subs[i].update();
    }
  }
}
```

é€šè¿‡ defineReactive æ–¹æ³•å°† data ä¸­çš„æ•°æ®è¿›è¡Œå“åº”å¼åï¼Œè™½ç„¶å¯ä»¥ç›‘å¬åˆ°æ•°æ®çš„å˜åŒ–äº†ï¼Œä½†æ˜¯æ€ä¹ˆå¤„ç†é€šçŸ¥è§†å›¾å°±æ›´æ–°å‘¢ï¼Ÿ

Dep å°±æ˜¯æ”¶é›†ã€ç©¶ç«Ÿè¦é€šçŸ¥åˆ°å“ªé‡Œçš„ã€‘ã€‚

æ¯”å¦‚ä¸‹é¢çš„ä»£ç æ¡ˆä¾‹ï¼Œè™½ç„¶ data ä¸­æœ‰ text å’Œ message å±æ€§ï¼Œä½†æ˜¯åªæœ‰ message è¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œè‡³äº text æ— è®ºæ€ä¹ˆå˜åŒ–éƒ½å½±å“ä¸åˆ°è§†å›¾çš„å±•ç¤ºï¼Œå› æ­¤ä»…ä»…å¯¹ message è¿›è¡Œæ”¶é›†å³å¯ï¼Œå¯ä»¥é¿å…ä¸€äº›æ— ç”¨çš„å·¥ä½œã€‚

é‚£è¿™ä¸ªæ—¶å€™ message çš„ Dep å°±æ”¶é›†åˆ°äº†ä¸€ä¸ªä¾èµ–ï¼Œè¿™ä¸ªä¾èµ–å°±æ˜¯ç”¨æ¥ç®¡ç† data ä¸­ message å˜åŒ–çš„ã€‚

```jsx
<div>
    <p>{{message}}</p>
</div>

data: {
  text: 'hello world',
  message: 'hello vue',
}
```

å½“ä½¿ç”¨ watch å±æ€§æ—¶ï¼Œä¹Ÿå°±æ˜¯å¼€å‘è€…è‡ªå®šä¹‰çš„ç›‘å¬æŸä¸ª data ä¸­å±æ€§çš„å˜åŒ–ã€‚

æ¯”å¦‚ç›‘å¬ message çš„å˜åŒ–ï¼Œmessage å˜åŒ–æ—¶æˆ‘ä»¬å°±è¦é€šçŸ¥åˆ° watch è¿™ä¸ªé’©å­ï¼Œè®©å®ƒå»æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

è¿™ä¸ªæ—¶å€™ message çš„ Dep å°±æ”¶é›†åˆ°äº†ä¸¤ä¸ªä¾èµ–ï¼Œç¬¬äºŒä¸ªä¾èµ–å°±æ˜¯ç”¨æ¥ç®¡ç† watch ä¸­ message å˜åŒ–çš„ã€‚

å½“å¼€å‘è€…è‡ªå®šä¹‰ computed è®¡ç®—å±æ€§æ—¶ï¼Œå¦‚ä¸‹ messageT å±æ€§ï¼Œæ˜¯ä¾èµ– message çš„å˜åŒ–çš„ã€‚

å› æ­¤ message å˜åŒ–æ—¶æˆ‘ä»¬ä¹Ÿè¦é€šçŸ¥åˆ° computedï¼Œè®©å®ƒå»æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚ 

è¿™ä¸ªæ—¶å€™ message çš„ Dep å°±æ”¶é›†åˆ°äº†ä¸‰ä¸ªä¾èµ–ï¼Œè¿™ä¸ªä¾èµ–å°±æ˜¯ç”¨æ¥ç®¡ç† computed ä¸­ message å˜åŒ–çš„ã€‚

**ä¸€ä¸ªå±æ€§å¯èƒ½æœ‰å¤šä¸ªä¾èµ–ï¼Œæ¯ä¸ªå“åº”å¼æ•°æ®éƒ½æœ‰ä¸€ä¸ª Dep æ¥ç®¡ç†å®ƒçš„ä¾èµ–**

### å¦‚ä½•æ”¶é›†ä¾èµ–

å¦‚ä½•çŸ¥é“ data ä¸­çš„æŸä¸ªå±æ€§è¢«ä½¿ç”¨äº†ï¼Œç­”æ¡ˆå°±æ˜¯ Object.definePropertyï¼Œå› ä¸ºè¯»å–æŸä¸ªå±æ€§å°±ä¼šè§¦å‘ get æ–¹æ³•ã€‚å¯ä»¥å°†ä»£ç è¿›è¡Œå¦‚ä¸‹æ”¹é€ 

```jsx
function defineReactive(obj, key, val) {
  let Dep;// ä¾èµ–Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: () => {
      console.log("æˆ‘è¢«è¯»äº†ï¼Œæˆ‘è¦ä¸è¦åšç‚¹ä»€ä¹ˆå¥½?");
// è¢«è¯»å–äº†ï¼Œå°†è¿™ä¸ªä¾èµ–æ”¶é›†èµ·æ¥
      Dep.depend();// æœ¬æ¬¡æ–°å¢return val;
    },
    set: (newVal) => {
      if (val === newVal) {
        return;
      }
      val = newVal;
// è¢«æ”¹å˜äº†ï¼Œé€šçŸ¥ä¾èµ–å»æ›´æ–°
      Dep.notify();// æœ¬æ¬¡æ–°å¢console.log("æ•°æ®è¢«æ”¹å˜äº†ï¼Œæˆ‘è¦æŠŠæ–°çš„å€¼æ¸²æŸ“åˆ°é¡µé¢ä¸Šå»!");
    },
  });
}
```

### ä»€ä¹ˆæ˜¯ä¾èµ–

é‚£æ‰€è°“çš„ä¾èµ–ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸Šé¢çš„å›¾ä¸­å·²ç»æš´éœ²äº†ç­”æ¡ˆï¼Œå°±æ˜¯ **Watcher**ã€‚

### Watcher ã€Œä¸­ä»‹ã€

Watcher å°±æ˜¯ç±»ä¼¼ä¸­ä»‹çš„è§’è‰²ã€‚

æ¯”å¦‚ message å°±æœ‰ä¸‰ä¸ªä¸­ä»‹ï¼Œå½“ message å˜åŒ–ï¼Œå°±é€šçŸ¥è¿™ä¸‰ä¸ªä¸­ä»‹ï¼Œä»–ä»¬å°±å»æ‰§è¡Œå„è‡ªéœ€è¦åšçš„å˜åŒ–ã€‚

Watcher èƒ½å¤Ÿæ§åˆ¶è‡ªå·±å±äºå“ªä¸ªï¼Œæ˜¯ data ä¸­çš„å±æ€§çš„è¿˜æ˜¯ watchï¼Œæˆ–è€…æ˜¯ computedï¼ŒWatcher è‡ªå·±æœ‰ç»Ÿä¸€çš„æ›´æ–°å…¥å£ï¼Œåªè¦ä½ é€šçŸ¥å®ƒï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„æ›´æ–°æ–¹æ³•ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥æ¨æµ‹å‡ºï¼ŒWatcher å¿…é¡»è¦æœ‰çš„ 2 ä¸ªæ–¹æ³•ã€‚ä¸€ä¸ªå°±æ˜¯é€šçŸ¥å˜åŒ–ï¼Œå¦ä¸€ä¸ªå°±æ˜¯è¢«æ”¶é›†èµ·æ¥åˆ° Dep ä¸­å»ã€‚

```jsx
class Watcher {
    addDep() {
// æˆ‘è¿™ä¸ªWatcherè¦è¢«å¡åˆ°Depé‡Œå»äº†~~
    },
    update() {
// Depé€šçŸ¥æˆ‘æ›´æ–°å‘¢~~
    },
}
```

### **å¤§è‡´æµç¨‹**

- å‘ç”Ÿåœ¨ beforeCreate å’Œ created ä¹‹é—´ initState(vm)ä¸­çš„ defineProperty
- å‘ç”Ÿåœ¨ beforeMount å’Œ mounted ä¹‹é—´çš„ Dep å’Œ Watcher çš„åˆå§‹åŒ–
- å‘ç”Ÿåœ¨ beforeUpdate å‰åˆ° updated è§¦å‘ï¼Œè¿™æœŸé—´ Watcher çš„ç›¸å…³å˜åŒ–

> vueå°†dataåˆå§‹åŒ–ä¸ºä¸€ä¸ªObserverå¹¶å¯¹å¯¹è±¡ä¸­çš„æ¯ä¸ªå€¼ï¼Œé‡å†™äº†å…¶ä¸­çš„getã€setï¼Œdataä¸­çš„æ¯ä¸ªkeyï¼Œéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ä¾èµ–æ”¶é›†å™¨ã€‚
> 

> åœ¨getä¸­ï¼Œå‘ä¾èµ–æ”¶é›†å™¨æ·»åŠ äº†ç›‘å¬ï¼Œåœ¨mountæ—¶ï¼Œå®ä¾‹äº†ä¸€ä¸ªWatcherï¼Œå°†æ”¶é›†å™¨çš„ç›®æ ‡æŒ‡å‘äº†å½“å‰Watcherã€‚
> 

> åœ¨dataå€¼å‘ç”Ÿå˜æ›´æ—¶ï¼Œè§¦å‘setï¼Œè§¦å‘äº†ä¾èµ–æ”¶é›†å™¨ä¸­çš„æ‰€æœ‰ç›‘å¬çš„æ›´æ–°ï¼Œæ¥è§¦å‘Watcher.update
>